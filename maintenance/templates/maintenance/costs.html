
{% comment %} START costs
======================================================================================== {% endcomment %}
<div aria-hidden="true" data-backdrop="static" style='z-index:2000' class="onboarding-modal modal fade animated" id="add_cost_modal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-centered" role="document">
        <form method="POST" id='add_cost_form'>
            <div class="modal-content">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span class="close-label">Close</span><span class="os-icon os-icon-close"></span></button>
                <div class="onboarding-slider-w cost_sub">
                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title display-8 text-center fancy_text3 cost_title">Maintenance costs</h4>
                            <hr>
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-group">
                                        <label class="control-label">What type of cost is this?</label>
                                        <select class="form-control " name="cost_type" id="mc_material_type">
                                            <option selected value="material" class="display-7sm">Material cost</option>
                                            <option value="labour" class="display-7sm">Labour cost</option>
                                        </select> </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12 col-12">
                                    <div class="form-group"> <label id='material_label_name' for="">Material name</label>
                                        <div class="input-group mb-2 mb-sm-0">
                                            <input class="form-control" placeholder="Example: New sink" type="text" name="cost_name" id="mc_material">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row d-none quantity_column">
                                <div class="col-sm-12 col-12">
                                    <div class="form-group"> <label class="" for="">How many do you need?</label>
                                        <div class="input-group mb-2 mb-sm-0">
                                            <input class="form-control" placeholder="Example: 17" type="number" name="cost_number" id="mc_material_qty">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-group "><label>Why do we need this? </label><textarea placeholder="Example: We need this to replace the valve" class="form-control" rows="5" name="cost_description" id="mc_desc"></textarea></div>
                                </div>
                            </div>
                            <input type="hidden1" name="costs_id" id="costs_id">
                            <input type="hidden1" name="manitenance" id="m_id">
                            
                        </div>
                    </div>
                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title display-8 text-center"></h4>
                            <hr>
                            <div class="row">
                                <div class="col-sm-12 col-12">
                                    <div class="form-group"> <label class='' for="">What is the total cost? (in Ksh)</label>
                                        <div class="input-group mb-2 mb-sm-0">
                                            <input class="form-control" placeholder="Example: Ksh 10,000" type="number" name="cost_total" id="mc_cost">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-group ">
                                        <label class="control-label">Has this been paid for yet?</label>
                                        <select class="form-control" name="paid" id="mc_cost_status">
                                            <option value="paid">Yes</option>
                                            <option selected value="not paid">No</option>
                                        </select> </div>
                                </div>
                            </div>
                            <div class="row d-none paid_for_column">
                                <div class="col-sm-12">
                                    <div class="form-group  ">
                                        <label for=""> When was this paid for?</label>
                                        <div class="date-input"><input autocomplete="off" class="date_with_end form-control editable" placeholder="Select date" type="text" name="paid_date" id="mc_cost_date"></div>
                                    </div>
                                </div>
                            </div>
                          
                            <div class="row d-none paid_for_column">
                                <div class="col-sm-12">
                                    <div class="form-group required">
                                        <label class="control-label">Paid by</label>
                                        <select class="form-control " required="required" name="paid_by" id="mc_cost_paid_by">
                                            <option selected value="bank">Bank</option>
                                            <option value="us">us</option>
                                            <option value="tenant">tenant</option>
                                        </select> </div>
                                </div>
                            </div>
                        
                         
                        </div>
                    </div>
                   
                    <div class="onboarding-slide">
                        <div class="onboarding-media"><img alt="" src="<?php echo base_url(); ?>/img/images/payment.webp" width="80px">
                        </div>
                        <div class="onboarding-content with-gradient">
                            <input type="hidden" name="cost_action_type" id="cost_action_type">
                            <h4 class="onboarding-title lead display-8 text-center">Are you done?</h4>
                            <div class="form-buttons-w d-flex flex-row justify-content-end">
                                <button class="btn btn-primary p-3" type="submit" id="submit_cost">Upload
                                    records</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div aria-hidden="true" data-backdrop="static" class="onboarding-modal modal fade animated" id="cost_modal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-centered modal-lg" role="document">
        <div class="modal-content">
            <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span class="close-label">Close</span><span class="os-icon os-icon-close"></span></button>
            <div class="onboarding-slider-w cost_main">
                <div class="onboarding-slide">
                    <div class="onboarding-content with-gradient">
                        <h4 class=" mt-5 onboarding-title display-9 fancy_text5 lead text-center" style="color:#B3B6B7 "><span>Materials/ labour expenses</span></h4>
                        <legend class='text-center'><span class='display-8 text-center text-primary '> </span> </legend>
                        <input type="hidden1" name="cost_success_type" id="cost_success_type">
                        <input type="hidden1" name="add_cost_id" id="add_cost_id">
                    </div>
                </div>
                <div class="onboarding-slide">
                    <div class="onboarding-content with-gradient">
                        <div class="row mb-2">
                            <div class="d-flex justify-content-between mb-5">
                                <button class="btn btn-primary justify-content-end px-5 py-2 mr-sm-4 text-white" id="add_cost_button" type='button'><span>Click to add</span></button>
                            </div>
                        </div>

                        <div class="table-responsive" style="cursor: pointer;">
                            <table id='cost_table' class="table table-lightborder display responsive nowrap" data-turbolinks="false" style="width:100%">
                                <thead>
                                    <tr>
                                        <th class="text-left">Labour/Material</th>
                                        <th class="text-left">Total cost</th>
                                        <th class="text-left">Status</th>
                                        <th class="text-left">Priority</th>
                                        <th class="text-left"></th>
                                        <th class="text-left"></th>
                                    </tr>
                                </thead>
                                <tbody class="text-left">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="onboarding-slide">
                    <div class="onboarding-content with-gradient">
                        <h4 class="onboarding-title lead display-8 text-center">Are you done?</h4>
                        <div class="form-buttons-w d-flex flex-row justify-content-end">
                            <button class="btn btn-primary py-3 px-5" type="button" id="submit_final_cost">Continue
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% comment %} END costs
======================================================================================== {% endcomment %}
{% comment %} START documents
======================================================================================== {% endcomment %}
<div aria-hidden="true" data-backdrop="static" class="onboarding-modal modal fade animated" id="attachment_image_modal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-centered" role="document">
        <form method="POST" id='attachment_image_form'>
            <div class="modal-content">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span class="close-label">Close</span><span class="os-icon os-icon-close"></span></button>
                <div class="onboarding-slider-w attachment_slide">
                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title display-8 text-left fancy_text5">Attachment name</h4>
                            <hr>
                            <div class="row mb-4 ">
                                <div class="col-sm-12">
                                    <div class="form-group required">
                                        <label class="control-label">What is this?</label>
                                        <input class="form-control editable" type="text" placeholder="Example:Bathroom sink" min="1" name="name" id="image_name">
                                    </div>
                                </div>
                            </div>
                            <input type="hidden1" name="attachment_id2" id="attachment_id2">
                        </div>
                    </div>
                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title display-7 text-left fancy_text4">Click to attach</h4>
                            <hr>
                            <div class="mb-5">
                                <label for="" class='text-left col-sm-12  fancy_text3 text-secondary'> <span class='fancy_text4 text-primary'>Allowed types</span>| jpg,png,jpeg |</label>
                                <input type="file" name='document' class="form-control-file btn btn-outline-primary px-4 py-4" id="lease_file">
                            </div>
                            <!-- <div class="form-buttons-w d-flex flex-row justify-content-between">
                                <div class="cancel-process steps p-2 lead justify-content-start"><a href="#" aria-label="Close" data-dismiss="modal">Cancel the process</a></div>
                                <button class="btn btn-primary px-5 py-3 step-button justify-content-end" id="submit_attachment" type="submit">Upload attachment</button>
                            </div> -->
                        </div>
                    </div>
                    <div class="onboarding-slide">
                        
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title lead display-8 text-center">Are you done?</h4>
                            <div class="form-buttons-w d-flex flex-row justify-content-end">
                                <button class="btn btn-primary p-3" type="submit" id="submit_attachment">Upload
                                    attachment</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </form>
    </div>
</div>

<div aria-hidden="true" data-backdrop="static" class="onboarding-modal modal fade animated" id="attachment_modal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-centered modal-lg" role="document">
        <div class="modal-content">
            <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span class="close-label">Close</span><span class="os-icon os-icon-close"></span></button>
            <div class="onboarding-slider-w attachment_main">
                <div class="onboarding-slide">
                    <div class="onboarding-content with-gradient">
                        <h4 class=" mt-5 onboarding-title display-9 fancy_text5 lead text-center" style="color:#B3B6B7 "><span>Photos of the issue (optional)</span></h4>
                        <legend class='text-center'><span class='display-8 text-center text-primary '> </span> </legend>
                        <input type="hidden" name="attachment_success_type" id="attachment_success_type">
                        <input type="hidden" name="attachment_id" id="attachment_id">
                        <input type="hidden" name="attachment_property" id="attachment_property">
                    </div>
                </div>
                <div class="onboarding-slide">
                    <div class="onboarding-content with-gradient">
                        <div class="row mb-2">
                            <div class="d-flex justify-content-between mb-5">
                                <button class="btn btn-primary justify-content-end px-5 py-2 mr-sm-4 text-white" id="attachment_button" type='button'><span>Click to attach</span></button>
                            </div>
                        </div>

                        <div class="table-responsive" style="cursor: pointer;">
                            <table id='attachment_table' class="table table-lightborder display responsive nowrap" data-turbolinks="false" style="width:100%">
                                <thead>
                                    <tr>
                                        <th class="text-left"></th>
                                        <th class="text-left"></th>
                                        <th class="text-left">Download</th>
                                        <th class="text-left">Delete</th>
                                    </tr>
                                </thead>
                                <tbody class="text-left">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="onboarding-slide">
                    <div class="onboarding-content with-gradient">
                        <h4 class="onboarding-title lead display-8 text-center">Are you done?</h4>
                        <div class="form-buttons-w d-flex flex-row justify-content-end">
                            <button class="btn btn-primary py-3 px-5" type="button" id="submit_final_attachment">Finish
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% comment %} END documents
======================================================================================== {% endcomment %}
<script>
    $(document).on('change', '#mc_cost_status', function() {
        var request_type = $(this).val();
        if (request_type == "paid") {
            $('.paid_for_column').removeClass('d-none');
            $('.was_is').text('was this');
           
        } else if (request_type == "not paid") {
            $('.paid_for_column').addClass('d-none');
            $('#mc_cost_date').val("");
            $('.was_is').text('is this');
        }
        $('.onboarding-modal .onboarding-slider-w').slick('setPosition');
    });
    $(document).on('click', '#submit_final_cost', function() {
        data = $('#cost_success_type').val();
        insert_id = $('#add_cost_id').val();
        if (data == "add") {
            $('#attachment_success_type').val("Add");
            attachment_function(insert_id);
            $('#attachment_modal').modal('show');
        } else {
            $('#success_text').text("You can view/edit Maintenance costs anytime.");
            $('#success_alert').modal('show');
        }
        $('#cost_modal').modal('hide');
    });
    $(document).on('click', '.cost_button', function() {
        var data = $(this).attr("id");
        var attachment = data;
    
        cost_function(attachment);
        $('#cost_success_type').val("edit");
        $('#submit_final_cost').text('Finish');
        $('#cost_modal').modal('show');

    });
    $(document).on('click', '#add_cost_button', function() {
        $('#add_cost_form')[0].reset();
        $('#cost_action_type').val("Add");
        $('#mc_cost_status').val("not paid").change();
        $('#mc_material_type').val("material").change();
        $('#material_label_name').text("Material name");
        $('.quantity_column').removeClass('d-none');
        $('#m_id').val($('#add_cost_id').val());
        $('#add_cost_modal').modal('show');
    });

    $(document).on('click', '.edit_cost', function() {
        $('#add_cost_form')[0].reset();
        var costs_id = $(this).attr("id");
        $.ajax({
            url : "{% url 'maintenance:cost-rud' id=12345 %}".replace(/12345/, costs_id).toString(),
            method: "GET",
          
            data: {
                cost_id: costs_id
            },
            dataType: "json",
            success: function(data) {
                $('.cost_title').text(data.name);
                $('#costs_id').val(id);
                $('#cost_action_type').val('edit');
                $('#m_id').val(data.maintenance);
                $('#mc_cost_paid_by').val(data.paid_by).change();
             
                $('#mc_material').val(data.cost_name);
                $('#mc_material_type').val(data.cost_type).change();
                $('#mc_cost').val(data.cost_total);
                $('#mc_cost_date').val(data.paid_date);
                $('#mc_cost_status').val(data.paid).change();
                $('#mc_material_qty').val(data.cost_number);
                $('#mc_desc').val(data.cost_description);
               
                $('#add_cost_modal').modal('show');

            }
        })
    });
    $(document).on('submit', '#add_cost_form', function(event) {
        var action_type=$('#cost_action_type').val()
        if (action_type =='add'){
            var method='POST';
            var url = '{% url "maintenance:cost-listcreate" %}';
        }
        if (action_type =='edit'){
            var id= $('#costs_id').val();
            var method='PUT';
            var url = "{% url 'maintenance:cost-rud' id=12345 %}".replace(/12345/, id).toString();
        }
        var form_data = new FormData(this);
        event.preventDefault();
        $.ajax({
            method: method,
            url: url,
            data: form_data,
            contentType: false,
            processData: false,
            dataType: "json",
            beforeSend: function() {
                $('#submit_cost').attr('disabled', 'disabled');
                $("#submit_cost").html("Please wait");
            },
            success: function(data) {
                $('#submit_cost').attr('disabled', false);
                $("#submit_cost").html("Upload records");
                if (data.success) {
                    cost_function(data.maintenance);
                    $('#add_cost_modal').modal('hide');
                    $('#success_text').text(data.success);
                    $('#success_alert').modal('show');
                    f_requests_table();
                }
                if (data.error) {
                    $('#oops_text').text(data.error);
                    $('#oops_alert').modal('show');
                }
            },
            error: function(jqXhr) {
                $('#add_cost_modal').modal('hide');
                $('#submit_cost').attr('disabled', false);
                $("#submit_cost").html("Upload records");
                $('#oops_text').text("Something went wrong, try again later");
                $('#oops_alert').modal('show');

            }
        });
    });
    $(document).on('click', '.remove_cost', function() {
        var data = $(this).attr("id");
        var data_split = data.split(",");
        var cost_id = data_split[0];
        var maintenance = data_split[1];
        $('#confirm_title').text("Are you sure?");
        $('#confirm_extra').text("Confirming the removal of this cost");
        $('#confirm_button').text("Confirm removal");
        $('#confirm_alert').modal('show');
        $('#confirmYes').off().on('click', function() {
            $.ajax({
                url :"{% url 'maintenance:cost-rud' id=12345 %}".replace(/12345/, id).toString(),
                method: "DELETE",		
                dataType: "json",
                data: {
                    cost_id: cost_id,
                },
                success: function(data) {
                    if (data.success) {
                        cost_function(maintenance);
                        $('#confirm_alert').modal('hide');
                        f_requests_table();
                    }
                    if (data.error) {
                        $('#oops_text').text(data.error);
                        $('#oops_alert').modal('show');
                        $('#confirm_alert').modal('hide');
                    }
                },
                error: function(jqXhr) {
                    $('#oops_text').text("Something went wrong, try again later");
                    $('#oops_alert').modal('show');
                    $('#confirm_alert').modal('hide');
                }

            });
        });
        $('#confirmNo').off().on('click', function() {
            $('#confirm_alert').modal('hide');
        });
    });

    function cost_function(maintenance) {
        url_data = '{% url "maintenance:cost-listcreate" %}';
        $('#cost_table').DataTable({
            "destroy": true,
            "bAutoWidth": false,
            // "bLengthChange": false,
            "ordering": false,
            "oLanguage": {
                "sEmptyTable": "No materials used"
            },
            initComplete: function() {
                var btns = $('.dt-button');
                btns.removeClass('dt-button');
            },
            "ajax": {
                "url": url_data,
                "type": 'post',
                "data": {
                    "maintenance": maintenance,
                },
            },
            "searching": false,
            "bPaginate": false,
            "bInfo": false,
            "bProcessing": true,
            "scrollCollapse": true,
            "paging": false,

        });
        jQuery('#cost_table').wrap('<div class="dataTables_scroll" />');
        $('#cost_table').css('wdith', '100%');
        $('#cost_table').css('min-height', '200px');
        $('#add_cost_id').val(maintenance);
    }
    $(document).on('change', '#mc_material_type', function() {
        var request_type = $(this).val();
        if (request_type == "material") {
            $('#material_label_name').text("Material name");
            $('.quantity_column').removeClass('d-none');
        } else if (request_type == "labour") {
            $('#material_label_name').text("labourer's name");
            $('.quantity_column').addClass('d-none');
            $('#mc_material_qty').val("");
        }
        $('.onboarding-modal .onboarding-slider-w').slick('setPosition');

    });
</script>