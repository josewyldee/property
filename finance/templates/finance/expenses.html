{% extends 'base.html' %}
{% load static %}

{% block title %} {{request.path}} {% endblock title %}

{% block modal %}
<div aria-hidden="true" data-backdrop="static" class="onboarding-modal modal fade animated" id="payment_modal"
    role="dialog" tabindex="-1">
    <div class="modal-dialog modal-centered" role="document">
        <form method="POST" id='payment_form'>
            <div class="modal-content">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span
                        class="close-label">Close</span><span class="os-icon os-icon-close"></span></button>
                <div class="onboarding-slider-w">

                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title display-10 fancy_text4 lead text-left">Payment information</h4>
                            <hr>

                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-group ">
                                        <label class="control-label">Paid to</label>
                                        <select id='expense_payee' name="payee"
                                            class="form-control selectpicker form-control-sm floating_select_big d-flex justify-content-end"
                                            data-live-search="true" data-size="4">
                                            <option selected disabled>Select a payee</option>
                                            <option value="add_payee" class="text-primary">Click to add</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group required">
                                        <label class="control-label">How was the payment made?</label>
                                        <select class="form-control" required="required" name="paid_through"
                                            id="paid_through">
                                            <option selected value="cash">cash</option>
                                            <option value="Cashier's check">Cashier's check</option>
                                            <option value="Check">Check</option>
                                            <option value="Credit card">Credit card</option>
                                            <option value="Direct deposit">Direct deposit</option>
                                            <option value="Electronic payment">Electronic payment</option>
                                            <option value="Money order">Money order</option>
                                        </select> </div>
                                </div>
                            </div>

                            <div class="reference_row d-none">
                                <div class="row">

                                    <div class="col-sm-12">
                                        <div class="form-group required">
                                            <label class="control-label">What was the <span
                                                    class="reference_title">reference number</span>?
                                            </label>
                                            <input class="form-control editable" type="text"
                                                placeholder="Select reference number" name="ref_no" id="ref_no">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group">
                                        <label for="">How much was paid?</label>
                                        <input class="form-control paid_amount" placeholder="Enter amount"
                                            autocomplete="off" type="text" id='amount' name="amount">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group required ">
                                        <label for=""> When was this paid?</label>
                                        <div class="date-input"><input autocomplete="off"
                                                class="past_date form-control editable" placeholder="Select the date"
                                                type="text" name="paid_on" id="paid_on"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="onboarding-slide">

                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title display-8 fancy_text4 lead text-left">Attach receipt</h4>
                            <hr>


                            <div class="row show_receipt">
                                <div class="p-4 col-12 mb-4 border d-flex justify-content-around"
                                    style="background-color: #FFFFE0;">
                                    <div class="text-secondary">
                                        <div class=" px-3 form-desc  display-7sm fancy_text3 p-2"
                                            style="line-height: 150%;font-size:18px;">
                                            <a href="#" download class="fancy_text5 text-primary" id="view_receipt"
                                                style="border-bottom:2px solid #3B4CB8"> View receipt</a>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="upload_receipt file mt-4">
                                <label for="" style="font-size:15px"
                                    class='text-center col-sm-12  fancy_text3 text-black '>
                                    <span class='fancy_text4 text-primary font-w600'>Select a file to upload </span>
                                </label>
                                <input type="file" name='receipt'
                                    class="form-control-file btn-rounded btn btn-outline-primary px-5 py-2"
                                    id="document_expense">
                            </div>

                        </div>
                    </div>
                    <div class="onboarding-slide">

                        <div class="onboarding-content with-gradient">
                            <input type="hidden" id="payment_id" name="id">
                            <input type="hidden" id="status" name="status" value="paid">
                            <input type="hidden" id="payment_action" value="add">

                            <h4 class="onboarding-title lead display-8 text-center">Are you done?</h4>
                            <div class="form-buttons-w d-flex flex-row justify-content-end">
                                <button class="btn btn-primary px-5 py-2" type="submit" id="submit_payment">Click to
                                    proccess</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<div aria-hidden="true" data-backdrop="static" class="onboarding-modal modal fade animated" id="expense_modal"
    role="dialog" tabindex="-1">
    <div class="modal-dialog modal-centered" role="document">
        <form method="POST" id='expense_form'>
            <div class="modal-content">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span
                        class="close-label">Close</span><span class="os-icon os-icon-close"></span></button>
                <div class="onboarding-slider-w">

                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title display-8 fancy_text4 lead text-left">About the expense</h4>
                            <hr>
                            <div class="row building-expense">
                                <div class="col-sm-12">
                                    <div class="form-group ">
                                        <label class="control-label">Select the building</label>
                                        <select id='property' name="property" class="form-control selectpicker "
                                            data-live-search="true" data-size="4">
                                            <option selected value="all" class="display-8sm">All</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row ">
                                <div class="col-sm-12">
                                    <div class="form-group ">
                                        <label class="control-label">Expense name?</label>
                                        <input class="form-control editable" type="text" placeholder="Example:Tax fees "
                                            name="expense_name" id="expense_name">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group"><label for="">Category</label>
                                        <select class="form-control" id="expense_group" name="expense_group">
                                            <option value="expense">Expense</option>
                                            <option value="tax">Tax</option>
                                            <option value="maintenance">maintenance</option>
                                            <option value="rent and development to authorities">Rent and development to
                                                authorities</option>
                                            <option value="custom">other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row show_custom_utility d-none">
                                <div class="col-sm-12">
                                    <div class="form-group ">
                                        <label class="control-label">What is the custom category?</label>
                                        <input class="form-control editable" type="text" placeholder="Example:Tax fees "
                                            name="expense_category" id="expense_category">
                                    </div>
                                </div>
                            </div>


                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group ">
                                        <label class="control-label">Description</label>
                                        <textarea placeholder="Example: This was for cleaning services done"
                                            class="form-control textarea" rows="6" name="description"
                                            id="description"></textarea></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">

                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group required ">
                                        <label for=""> When was this created?</label>
                                        <div class="date-input"><input autocomplete="off"
                                                class="past_date form-control editable" placeholder="Select the date"
                                                type="text" name="created_on" id="created_on"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-4 show_fake_status">
                                <div class="col-12">
                                    <div class="form-group required">
                                        <label class="control-label">Has this been paid?</label>
                                        <select class="form-control" id="fake_status">
                                            <option value="paid">Yes</option>
                                            <option value="not paid">Not yet</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="onboarding-slide">

                        <div class="onboarding-content with-gradient">
                            <input type="hidden" id="expense_action_type" name="action_type">
                            <input type="hidden" id="expense_dummy_unit">
                            <input type="hidden" id="expense_data_id" name="expense_data_id">
                            <input type="hidden" id="expense_data_type" name="expense_data_type">
                            <input type="hidden" name="id" id="expense_id">
                            <h4 class="onboarding-title lead display-8 text-center">Are you done?</h4>
                            <div class="form-buttons-w d-flex flex-row justify-content-end">
                                <button class="btn btn-primary px-5 py-2" type="submit" id="submit_expense">Click to
                                    create</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div aria-hidden="true" data-backdrop="static" class="onboarding-modal modal fade animated sub_modal"
    data-tab="sub_modal" id="payee_modal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-centered" role="document">
        <form method="POST" id='payee_form'>
            <div class="modal-content">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button"><span
                        class="close-label">Close</span><span class="os-icon os-icon-close"></span></button>
                <div class="onboarding-slider-w sub_modal">
                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title2 text-muted lead "><span
                                    class="onboarding-title1 text-primary display-8 text-left fancy_text5 payee_name">Quickly
                                    add
                                    a payee</span></h4>
                            <div class="row">
                                <div class="col-12 ">
                                    <div class="form-group ">
                                        <label class="control-label">Company name <span
                                                class="text-black fancy_text5 display-8sm"><small> (Leave as blank if
                                                    none)</small></label>
                                        <input class="form-control editable " type="text"
                                            placeholder="Example:Dsiraeli management" name="company_name"
                                            id="company_name">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 ">
                                    <div class="form-group ">
                                        <label class="control-label">What was the name of the payee?</label>
                                        <input class="form-control editable " type="text"
                                            placeholder="Example:John Kamau" name="name" id="name">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class=" form-group">
                                        <label for="">Category</label>
                                        <select class=" form-control selectpicker dropup" data-dropup-auto="false"
                                            id='payee_category' name="payee_category" data-dropup-auto="false"
                                            data-size="4" data-live-search="true">
                                            <option value="Contractor">Contractor</option>
                                            <option value="Garbage collector">Garbage collector</option>
                                            <option value="Cleaning services">Cleaning services</option>
                                            <option value="Lender">Lender</option>
                                            <option value="Property management">Property management</option>
                                            <option value="Professional-legal">Professional-legal</option>
                                            <option value="Professional-accounting">Professional-accounting</option>
                                            <option value="Professional-realtor">Professional-realtor</option>
                                            <option value="Supplier">Supplier</option>
                                            <option value="Uncategorized">Uncategorized</option>
                                            <option value="Insurance">Insurance</option>
                                            <option value="Utility">Utility</option>
                                            <option value="Abc tenant">Abc tenant</option>
                                        </select>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title display-8 fancy_text4 lead text-left">Contact info</h4>
                            <hr>
                            {% comment %} <div class="row">
                                <div class="col-12 pl-0">
                                    <div class="form-group"><label class="control-label text-left">Code and phone
                                            number</label>
                                        <div class="input-group mb-2 mb-sm-0">
                                            <div class="input-group-append col-4 "><input autocomplete="off"
                                                    name="calling_code" id="calling_code" class="form-control editable"
                                                    type="number" placeholder="Example: 254" value="254"></div><input
                                                autocomplete="off" name="payee_phone" id="payee_phone"
                                                class="form-control editable" type="number"
                                                placeholder="Example: 705095622">
                                        </div>
                                    </div>
                                </div>
                            </div> {% endcomment %}
                            {% include 'partials/_calling_code.html' with name="calling_code" id="calling_code" class="calling_code" %}
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group"><label class='' for="">What is their phone number?</label>
                                        <div class="input-group mb-2 mb-sm-0">
                                            <div class="input-group-append">
                                                <div class="input-group-text per_calling">1</div>
                                            </div>
                                            <input class="form-control " maxlength="10" placeholder="Example: 720425412"
                                                type="phone" id='phone_number' name="phone_number">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 ">
                                    <div class="form-group">
                                        <label class="control-label">Email address</label>
                                        <input class="form-control editable" type="text"
                                            placeholder="Example: support@abctenant.com" id="email" name="email">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="onboarding-slide">
                        <div class="onboarding-content with-gradient">
                            <h4 class="onboarding-title display-8 fancy_text4 lead text-left">More info</h4>
                            <hr>
                            <div class="row">
                                <div class="col-12 ">
                                    <div class="form-group ">
                                        <label class="control-label">Website</label>
                                        <input class="form-control editable " type="text"
                                            placeholder="Example:www.abctenant.com" name="website" id="website">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-group ">
                                        <label class="control-label">Comment</label>
                                        <textarea placeholder="Example: They are our go to for such services"
                                            class="form-control textarea" rows="4" name="description"
                                            id="description"></textarea></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="onboarding-slide">

                        <div class="onboarding-content with-gradient">
                            <input type="hidden" name="id" id="payee_id">
                            <input type="hidden" name="action_type" id="payee_action_type">
                            <input type="hidden" id="payee_from">
                            <h4 class="onboarding-title lead display-8 text-center">Are you done?</h4>
                            <div class="form-buttons-w d-flex flex-row justify-content-end">
                                <button class="btn btn-primary px-5 py-2 submit" type="submit" id="submit_payee">Click
                                    to upload</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock modal %}
{% block content %}

<div class="content-body" style="min-height: 828px;">
    <!-- row -->
    <div class="container-fluid">
        <div class="card mx-3">
            <div class="card-header d-block mx-3 text-center">
                <h5 class="card-titles display-4 custom-card-title ">Tax and expenses</h5>
            </div>
        </div>

        <div class="row ">
            <div class="col-xl-12">
                <div class="col-12">
                    <div class="card px-3">

                        {% if request.user.is_syestem_admin %}

                        {% include 'partials/_table_extra.html' with button_class="expense_button" button_id="expense_button" button_text="Create an expense" total_class="total_expenses" total_text="records"  %}
                        {% endif %}
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="expense_table" class="display min-w850">
                                    <thead>
                                        <tr>
                                            <th class="text-left">Building</th>
                                            <th class="text-left">Expense</th>
                                            <th class="text-left">Amount</th>
                                            <th class="text-left">Created on</th>
                                            <th class="text-left">Status</th>
                                            <th class="text-left"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% block scripts %}
{% include 'partials/_select_options.html' %}
{% include 'partials/_date.html' %}

<link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.1.1/css/rowGroup.dataTables.min.css">
<script src="https://cdn.datatables.net/rowgroup/1.1.1/js/dataTables.rowGroup.min.js"></script>
<script>
    $(document).ready(function () {
        get_expense_table();
        select_option.select_property('#property');

        select_option.payees('#expense_payee');
    });

    $(document).on('click', '#payee_button', function () {
        $('#payee_form')[0].reset();
        $('.payee_name').text("Let's begin");
        $('#payee_action_type').val("add");
        $('#payee_from').val("modal");
        $('#payee_modal').modal('show');
    });
    $(document).on('click', '#expense_button', function () {
        
   
            $('#expense_form')[0].reset();
            $('.expense_name').text("Let's begin");
            $('.show_fake_status').removeClass('d-none');
            $('#fake_status').val('not paid').change();
            $('#expense_modal').modal('show');
            $('#expense_action_type').val("add");
            $('#paid_through').val("cash").change();


    });
   
    $(document).on('change', '#created_for', function () {
        var created_for = $(this).val();
        if (created_for == 'building') {
            $('.unit-expense').addClass('d-none');
        }
        if (created_for == 'unit') {
            $('.unit-expense').removeClass('d-none');
            select_option.select_units('#unit', 'all');

        }
        $('.onboarding-modal .onboarding-slider-w').slick('setPosition');
    });
    $(document).on('change', '#paid_through', function () {
        var payment_option = $(this).val();

        if (payment_option == 'cash') {

            $("#ref_no").attr("placeholder", "(ignore me)");
            $('.reference_title').text("(ignore me)");
            $('.reference_row').addClass("d-none");


        } else if (payment_option == "Cashier's check" || payment_option == 'Check') {
            $("#ref_no").attr("placeholder", "Check number");
            $('.reference_title').text("Check number");
            $('.reference_row').removeClass("d-none");
        } else {
            $("#ref_no").attr("placeholder", "Reference number");
            $('.reference_title').text("Reference number");
            $('.reference_row').removeClass("d-none");
        }
        $('.onboarding-modal .onboarding-slider-w').slick('setPosition');
    });
    $(document).on('change', '#expense_payee', function () {
        var the_data = $(this).val();
        if (the_data == 'add_payee') {
            $('#payee_action_type').val("add");
            $('#payee_from').val("select");
            $('#payee_modal').modal('show');
        }
    });
 
    $(document).on('submit', '#expense_form', function (event) {
        var status = $('#fake_status').val();
        var action_type = $('#expense_action_type').val();

        if (action_type == 'add') {
            var method = 'POST';
            var url = '{% url "finance:expense-listcreate" %}';
        }
        if (action_type == 'edit') {
            var id = $('#expense_id').val();
            var method = 'PUT';
            var url = "{% url 'finance:expense-rud' id=12345 %}".replace(/12345/, id).toString();
        }
        var form_data = new FormData(this);
        event.preventDefault();
        $.ajax({
            method: method,
            url: url,
            data: form_data,
            contentType: false,
            processData: false,
            dataType: "json",
            beforeSend: function () {
                $('#submit_expense').attr('disabled', 'disabled');
                $("#submit_expense").html("Please wait");
            },
            success: function (data) {
                $('#submit_expense').attr('disabled', false);
                $("#submit_expense").html("Upload records");
                if (data.success) {
                    get_expense_table();
                    $('#expense_modal').modal('hide');
                    if (status=="paid" && action_type == 'add'){
                        
                        $('#status').val("paid");
                       
                        $('#payment_id').val(data.response.id);
                        $('#payment_action').val("add");
                        
                        $(".upload_receipt").removeClass("d-none");
                        $(".show_receipt").addClass("d-none");
                        $('#document_expense').attr("name",'receipt').change();
                        $('#view_receipt').attr("href", "#").change();

                        $('#payment_modal').modal('show');
                    }else{
                        $('#success_text').text(data.success);
                        $('#success_alert').modal('show');
                    }
                
                }
                if (data.error) {
                    $('#oops_text').text(data.error);
                    $('#oops_alert').modal('show');
                }
            },
            error: function (jqXhr) {
                $('#submit_expense').attr('disabled', false);
                $("#submit_expense").html("Upload records");
                $('#oops_text').text("Something went wrong, try again later");
                $('#oops_alert').modal('show');
                $('#expense_modal').modal('hide');
            }

        });

    });
    $(document).on('click', '.add_payment', function () {
        var data = $(this).attr("id");
        var data_split = data.split(",");
        var id = data_split[0];
        var payment_action = data_split[1];
        $.ajax({
            url: "{% url 'finance:expense-rud' id=12345 %}".replace(/12345/, id).toString(),
            method: "GET",
            dataType: "json",
            data: {
                id: id
            },
            success: function (data) {
                $('#expense_action_type').val('edit');
                $('.expense_name').text(data.expense_name);
                $('#expense_data_id').val(data.data_id);
                $('#payment_id').val(data.id);
                $('#expense_data_type').val(data.data_type);
                $('#expense_id').val(data.id);
                $('#expense_dummy_unit').val(data.unit);
                $('#property').val(data.property).change();
                $('#description').val(data.description);
                $('#expense_payee').val(data.payee).change();
                $('#expense_name').val(data.expense_name);
                $('#expense_category').val(data.expense_category);
                $('#expense_group').val(data.expense_group).change();
                $('#created_on').val(data.created_on);
                $('#paid_through').val(data.paid_through).change();
                $('#ref_no').val(data.ref_no);
                $('#paid_on').val(data.paid_on);
                
                $('#status').val('paid');
                $('#payment_action').val(payment_action);
                if (payment_action=="edit"){
                   
                    $(".upload_receipt").addClass("d-none");
                    $(".show_receipt").removeClass("d-none");
                    $('#document_expense').attr("src", data.receipt).change();
                    $('#document_expense').attr("name",'nofile').change();
                    $('#view_receipt').attr("href", data.receipt).change();
                }else{
                    
                    $(".upload_receipt").removeClass("d-none");
                    $(".show_receipt").addClass("d-none");
                    $('#document_expense').attr("name",'receipt').change();
                    $('#view_receipt').attr("href", "#").change();
                }
               
            
             
                $('#amount').val(data.amount);
                if (data.created_for == 'building') {
                    $('.unit-expense').addClass('d-none');
                }
                

              
                $('#payment_modal').modal('show');

            }
        })
    });
  
    $(document).on('submit', '#payment_form', function (event) {
        var submit_data="yes";
        var document = $('#document_expense').val();
        var action=$('#payment_action').val();
        if (action=="add"){
            if(document){
                var submit_data="yes";
            }   else{
                var submit_data="no";
            }   
        } 
       
        var action_type = $('#expense_action_type').val();
            var id = $('#payment_id').val();
            var method = 'PUT';
            var url = "{% url 'finance:expense-rud' id=12345 %}".replace(/12345/, id).toString();
        
        var form_data = new FormData(this);
        event.preventDefault();
       if(submit_data=="yes"){
            $.ajax({
                method: method,
                url: url,
                data: form_data,
                contentType: false,
                processData: false,
                dataType: "json",
                beforeSend: function () {
                    $('#submit_payment').attr('disabled', 'disabled');
                    $("#submit_payment").html("Please wait");
                },
                success: function (data) {
                    $('#submit_payment').attr('disabled', false);
                    $("#submit_payment").html("Upload records");
                    if (data.success) {
                        get_expense_table();
                        $('#payment_modal').modal('hide');
                        $('#success_text').text("Payment was added succesfully.");
                        $('#success_alert').modal('show');
                    }
                    if (data.error) {
                        $('#oops_text').text(data.error);
                        $('#oops_alert').modal('show');
                    }
                },
                error: function (jqXhr) {
                    $('#submit_payment').attr('disabled', false);
                    $("#submit_payment").html("Upload records");
                    $('#oops_text').text("Something went wrong, try again later");
                    $('#oops_alert').modal('show');
                    $('#payment_modal').modal('hide');
                }
    
            });
      }else{
            $('#oops_text').text("Kindly attach a receipt");
            $('#oops_alert').modal('show');
        }
   

    });
    $(document).on('change', '#expense_group', function() {
        var category = $(this).val();
        if (category == "custom") {
            $(".show_custom_utility").removeClass("d-none");
        }else{
            $(".show_custom_utility").addClass("d-none");
        }
        $('.onboarding-modal .onboarding-slider-w').slick('setPosition');
    });
    $(document).on('click', '.edit_expense', function () {

        //    $('#expense_form')[0].reset();
        select_option.select_units('#unit', 'all');
        var id = $(this).attr("id");

        $.ajax({
            url: "{% url 'finance:expense-rud' id=12345 %}".replace(/12345/, id).toString(),
            method: "GET",
            dataType: "json",
            data: {
                id: id
            },
            success: function (data) {
                $('#expense_action_type').val('edit');
                //$('#created_for').val(data.created_for).change();
                $('.expense_name').text(data.expense_name);
                $('#expense_data_id').val(data.data_id);
                $('#expense_data_type').val(data.data_type);
                $('#expense_id').val(data.id);
                $('#expense_dummy_unit').val(data.unit);
                $('#property').val(data.property).change();
                $('#description').val(data.description);
                $('#expense_payee').val(data.payee).change();
                $('#expense_name').val(data.expense_name);
                $('#expense_category').val(data.expense_category);
                $('#expense_group').val(data.expense_group).change();
                $('#created_on').val(data.created_on);
                $('#paid_through').val(data.paid_through).change();
                $('#ref_no').val(data.ref_no);
                $('.show_fake_status').addClass('d-none');
                $('#fake_status').val(data.status).change();

                $('#amount').val(data.amount);
                if (data.created_for == 'building') {
                    $('.unit-expense').addClass('d-none');
                }
                if (data.created_for == 'unit') {
                    // select_option.select_units('#unit', data.property);
                    $('.unit-expense').removeClass('d-none');
                    $('#unit').val(data.unit).change();
                    $('.onboarding-modal .onboarding-slider-w').slick('setPosition');
                }
                $('#expense_modal').modal('show');

            }
        })
    });
    $(document).on('click', '.remove_expense', function () {
        var data = $(this).attr("id");
        var data_split = data.split(",");
        var delete_id = data_split[0];
        var delete_name = data_split[1];

        var delete_name_type = 'an expense';
        $('#confirm_title').text("Are you sure?");
        $('#confirm_extra').text("Confirming the removal of " + delete_name + " as " + delete_name_type);
        $('#confirm_button').text("Confirm removal");
        $('#confirm_alert').modal('show');
        $('#confirmYes').off().on('click', function () {
            $.ajax({
                url: "{% url 'finance:expense-rud' id=12345 %}".replace(/12345/,
                delete_id).toString(),
                method: "DELETE",
                dataType: "json",
                data: {
                    delete_id: delete_id,

                },
                success: function (data) {
                    if (data.success) {
                        $('#confirm_alert').modal('hide');
                        $('#success_text').text(data.success);
                        $('#success_alert').modal('show');
                        get_expense_table();
                    }
                    if (data.error) {
                        $('#oops_text').text(data.error);
                        $('#oops_alert').modal('show');
                        $('#confirm_alert').modal('hide');
                    }
                },
                error: function (jqXhr) {
                    $('#oops_text').text("Something went wrong, try again later");
                    $('#oops_alert').modal('show');
                    $('#confirm_alert').modal('hide');
                }

            });
        });
        $('#confirmNo').off().on('click', function () {
            $('#confirm_alert').modal('hide');
        });
    });

    function get_expense_table() {

        var url = "{% url 'finance:expense-listcreate' %}";
        $('#expense_table').DataTable({
            processing: true,
            serverSide: true,
            "destroy": true,
            "bAutoWidth": false,
            "responsive": true,
            // "bLengthChange": false,
            "ordering": false,
            "oLanguage": {
                "sEmptyTable": "No expenses added",
                "sStripClasses": "",
                "sSearch": "",
                "sSearchPlaceholder": "search...",
                "sLengthMenu": '<span>Rows per page:</span><select class="browser-default">' +
                    '<option value="10">10</option>' +
                    '<option value="20">20</option>' +
                    '<option value="30">30</option>' +
                    '<option value="40">40</option>' +
                    '<option value="50">50</option>' +
                    '<option value="50">100</option>' +

                    '</select></div>'
            },
            initComplete: function () {
                var btns = $('.dt-button');
                btns.removeClass('dt-button');
            },
            "ajax": {
                "url": url,


            },
            "columnDefs": [{
                    "width": 250,
                    "targets": 1
                },
                {
                    "visible": false,
                    "targets": 0,
                }
            ],
            "order": [
                [0, 'asc']
            ],
            "rowGroup": {
                "dataSrc": 0
            },
            "bPaginate": true,
            "bProcessing": true,
            "pageLength": 10,


            "fnDrawCallback": function () {
                $('.total_expenses').html(this.fnSettings().fnRecordsTotal());
            },

        });



    }

    //--------------------------------------------------------------------------------------------------------------------------------------------
    $(document).on('change', '#calling_code', function () {
        var the_data = $(this).val();
        $('.per_calling').text(the_data);
    });

    $(document).on('submit', '#payee_form', function (event) {
        var action_type = $('#payee_action_type').val();
        var method = 'POST';
        var url = '{% url "finance:payee-listcreate" %}';


        //var method = 'POST';
        //var url = '{% url "finance:payee-listcreate" %}';
        var form_data = new FormData(this);
        event.preventDefault();
        $.ajax({
            method: method,
            url: url,
            data: form_data,
            contentType: false,
            processData: false,
            dataType: "json",
            beforeSend: function () {
                $('#submit_payee').attr('disabled', 'disabled');
                $("#submit_payee").html("Please wait");
            },
            success: function (data) {
                $('#submit_payee').attr('disabled', false);
                $("#submit_payee").html("Upload records");
                if (data.success) {
                    select_option.payees('#expense_payee');

                    $('#payee_modal').modal('hide');
                }
                if (data.error) {
                    $('#oops_text').text(data.error);
                    $('#oops_alert').modal('show');
                }
            },
            error: function (jqXhr) {
                $('#submit_payee').attr('disabled', false);
                $("#submit_payee").html("Upload records");
                $('#oops_text').text("Something went wrong, try again later");
                $('#oops_alert').modal('show');
                $('#payee_modal').modal('hide');
            }

        });
    });
</script>
{% endblock scripts %}



{% endblock content %}


<!--**********************************
    Content body end
***********************************-->